<!DOCTYPE html>
<html lang="en" xmlns:x-transition="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords"
          content="DnD, D&D, –¥–Ω–¥, Dungeons and Dragons, –ø—ñ–¥–∑–µ–º–µ–ª–ª—è —Ç–∞ –¥—Ä–∞–∫–æ–Ω–∏, spells, –∑–∞–∫–ª–∏–Ω–∞–Ω–Ω—è, —á–∞—Ä—É–≤–∞–Ω–Ω—è, —Å–ø–µ–ª–∏, —Å–ø–µ–ª–ª–∏, —á–∞—Ä—É–Ω–∫–∏, —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é, –¥–Ω–¥ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é, holota, –ë—Ä–∞—Ç–∏ –ì–æ–ª–æ—Ç–∏">
    <meta name="author" content="Holota family">
    <meta name="application-name" content="spells holota family">
    <link href="{{ url_for('static', filename='css/style.css') }}"
          rel="stylesheet">
    <link href="{{ url_for('static', filename='images/dark-favicon.ico') }}"
          rel="icon" media="(prefers-color-scheme: light)">
    <link href="{{ url_for('static', filename='images/favicon.ico') }}"
          rel="icon" media="(prefers-color-scheme: dark)">
    <style>
        [x-cloak] {
            display: none !important;
        }
    </style>
    <script>
        window.isAuthenticated = {{ current_user.is_authenticated|tojson }}

    </script>
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.store('auth', {
                isOpened: false,
                open() {
                    this.isOpened = true;
                    Alpine.store('modal').open('auth')
                },
                pendingPath: null,
                require(path) {
                    if (window.isAuthenticated) {
                        window.location.href = path
                    } else {
                        this.pendingPath = path
                        this.isOpened = true
                    }
                },
                success() {
                    if (Alpine.store('modal').close('auth')) this.isOpened = false
                    window.isAuthenticated = true
                    if (this.pendingPath) window.location.href = this.pendingPath

                    if (window.location.pathname === '/spells' && !this.pendingPath) {
                        Alpine.store('notification').push('–í—Ö—ñ–¥ —É—Å–ø—ñ—à–Ω–∏–π ‚úÖ –¢–µ–ø–µ—Ä –≤–∏ –º–æ–∂–µ—Ç–µ –¥–æ–¥–∞–≤–∞—Ç–∏ –∑–∞–∫–ª–∏–Ω–∞–Ω–Ω—è –≤ –ö–Ω–∏–≥—É –ß–∞—Ä—ñ–≤!')
                        window.getSpellbookSpellIds()
                    }
                },
                close() {
                    this.isOpened = false
                    this.pendingPath = null

                    if (Alpine.store('modal').close('auth')) this.isOpened = false
                }
            })
            Alpine.store('logout', {
                isOpened: false,
                open() {
                    this.isOpened = true;
                    Alpine.store('modal').open('logout')
                },
                success() {
                    this.close()
                    window.isAuthenticated = false

                    if (window.location.pathname === '/spells') {
                        Alpine.store('spellbook').setAll([])
                        Alpine.store('notification').push('–í–∏ –≤–∏–π—à–ª–∏ –∑ –∞–∫–∞—É–Ω—Ç–∞ üëã')
                    } else {
                        window.location.href = '/spells'
                    }
                },
                close() {
                    if (Alpine.store('modal').close('logout')) this.isOpened = false
                }
            })
            Alpine.store('notification', {
                data: '',
                visible: false,
                timeoutId: null,
                push(message) {
                    if (this.timeoutId) {
                        clearTimeout(this.timeoutId)
                        this.timeoutId = null
                    }
                    this.data = message
                    this.visible = true

                    this.timeoutId = setTimeout(() => {
                        this.visible = false

                        setTimeout(() => {
                            this.data = ''
                            this.timeoutId = null
                        }, 300)
                    }, 3000)
                }
            })
            Alpine.store('spellbook', {
                ids: new Set(),
                has(id) {
                    return this.ids.has(id)
                },
                setAll(arr) {
                    this.ids = new Set(arr)
                },
                add(id) {
                    const next = new Set(this.ids);
                    next.add(id);
                    this.ids = next
                },
                remove(id) {
                    const next = new Set(this.ids);
                    next.delete(id);
                    this.ids = next
                }
            })
            Alpine.store('modal', {
                stack: [],
                open(modalName) {this.stack.push(modalName)},
                top() {return this.stack[this.stack.length -1]},
                close(modalName) {
                    return this.top() === modalName
                                    ? this.stack.pop()
                                    : false
                }
            })
        })
    </script>
    <script defer
            src="{{ url_for('static', filename='js/alpine.min.js') }}"></script>
</head>
<body class="bg-slate-900 text-gray-200 min-h-screen w-full" x-data>
<div class="flex min-h-screen w-full">
    <aside class="hidden md:flex flex-col justify-between gap-2 w-16 bg-slate-800 py-4 px-2 fixed left-0 top-0 h-full z-50">
        <div class="flex-flex-col gap-2">
            <a href="/spells" class="mb-2 flex items-center justify-center">
                <img src="{{ url_for('static', filename='images/logo.png') }}"
                     class="h-10 w-10 object-contain" alt="logo">
            </a>
            <a href="/spellbook"
               class="mb-2 p-0.5 rounded-lg hover:bg-violet-600 flex items-center justify-center w-12 h-12"
               title="–ö–Ω–∏–≥–∞ –ß–∞—Ä—ñ–≤"
               @click.prevent="$store.auth.require('/spellbook')">
                <img src="{{ url_for('static', filename='images/book-inactive.png') }}"
                     class="h-10 w-10 object-cover" alt="spellbook">
            </a>
        </div>
        <button
                class="p-0.5 rounded-lg hover:bg-violet-600 flex items-center justify-center w-12 h-12"
                title="–ü—Ä–æ—Ñ—ñ–ª—å"
                @click="window.isAuthenticated ? $store.logout.open() : $store.auth.open()">
            <svg class="h-10 w-10" fill="none" stroke="currentColor"
                 viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round"
                      d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963
                         0a9 9 0 1 0-11.963 0m11.963
                         0A8.966 8.966 0 0 1 12 21a8.966 8.966
                         0 0 1-5.982-2.275M15 9.75a3 3
                         0 1 1-6 0 3 3 0 0 1 6 0Z">
                </path>
            </svg>
        </button>
    </aside>

    <main class="flex-1 flex justify-center md:ml-16">
        {% block body %}{% endblock %}
    </main>
</div>
<nav class="md:hidden fixed inset-x-0 bottom-0 bg-slate-800 flex justify-around z-50 shadow">
    <a href="/spells" class="flex items-center py-2 text-xs">
        <img src="{{ url_for('static', filename='images/logo.png') }}"
             class="h-10 w-10 object-contain" alt="logo">
    </a>
    <a href="/spellbook" class="flex items-center py-2 text-xs"
       @click.prevent="$store.auth.require('/spellbook')">
        <img src="{{ url_for('static', filename='images/book-inactive.png') }}"
             class="h-10 w-10 object-cover" alt="spellbook">
    </a>
    <button class="flex items-center py-2 text-xs"
            @click="window.isAuthenticated ? $store.logout.open() : $store.auth.open()">
        <svg class="h-10 w-10" fill="none" stroke="currentColor"
             viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
                  d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488
                     7.488 0 0 0-5.982 2.975m11.963
                     0a9 9 0 1 0-11.963 0m11.963
                     0A8.966 8.966 0 0 1 12 21a8.966
                     8.966 0 0 1-5.982-2.275M15
                     9.75a3 3 0 1 1-6 0 3 3 0 0
                     1 6 0Z">
            </path>
        </svg>
    </button>
</nav>
<div x-show="$store.auth.isOpened"
     x-transition:enter="ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0"
     x-cloak
     @click.self="$store.auth.close()"
     class="fixed inset-0 z-50 bg-black/70 flex items-center justify-center p-4">
    <div class="bg-slate-800 rounded-xl w-full max-w-md flex-row justify-center px-4 py-3"
         @keydown.escape.window="$store.auth.close()">
        <div class="flex justify-between items-center">
            <h3 class="text-lg">–£–≤—ñ–π—Ç–∏</h3>
            <button @click="$store.auth.close()"
                    class="p-2 rounded hover:bg-slate-700">
                <svg xmlns="http://www.w3.org/2000/svg"
                     class="w-6 h-6 text-gray-300"
                     fill="none"
                     viewBox="0 0 24 24"
                     stroke="currentColor">
                    <path stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div class="text-wrap text-center mb-2">
            –í–≤–µ–¥—ñ—Ç—å –¥–∞–Ω—ñ –¥–ª—è —Å–≤–æ–≥–æ –Ω–æ–≤–æ–≥–æ –∞–∫–∞—É–Ω—Ç–∞ –∞–±–æ –≤–≤—ñ–π–¥—ñ—Ç—å,
            –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–≤—à–∏ –¥—ñ–π—Å–Ω—ñ
        </div>
        <form x-data="postForm()" @submit.prevent="submit" x-ref="form">
            <input class="rounded-xl w-full px-2 py-2 bg-slate-700 mb-2"
                   placeholder="–õ–æ–≥—ñ–Ω..."
                   x-model="login"
                   name="login"
                   required>
            <input class="rounded-xl w-full px-2 py-2 bg-slate-700 mb-2"
                   placeholder="–ü–∞—Ä–æ–ª—å..."
                   x-model="password"
                   name="password">
            <p x-show="error" class="text-red-600 my-3" x-text="error"></p>
            <button type="submit"
                    class="bg-slate-700 px-2 py-2 text-center w-full rounded-xl mt-2 mb-3">
                –£–≤—ñ–π—Ç–∏/–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è
            </button>
        </form>

    </div>
</div>
<div x-show="$store.logout.isOpened"
     x-cloak
     x-data="sendLogout()"
     x-transition:enter="ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0"
     class="inset-0 z-50 bg-black/70 flex items-center justify-center p-4 fixed"
     @click.self="$store.logout.close()"
>
    <div class="bg-slate-800 rounded-xl flex-col w-full max-w-md justify-center px-4 py-3"
         @keydown.escape.window="$store.logout.close()">
        <div class="flex justify-between items-center">
            <h3 class="text-2xl">–í–∏–π—Ç–∏?</h3>
            <button @click="$store.logout.close()"
                    class="p-2 rounded hover:bg-slate-700">
                <svg xmlns="http://www.w3.org/2000/svg"
                     class="w-6 h-6 text-gray-300"
                     fill="none"
                     viewBox="0 0 24 24"
                     stroke="currentColor">
                    <path stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <button class="w-full bg-slate-700 hover:bg-red-500 p-3 my-3 rounded-xl"
                @click="logout()">
            –í–∏–π—Ç–∏ –∑ –∞–∫–∞—É–Ω—Ç—É
        </button>

        <p class="my-3 text-red-500" x-show="error"></p>
    </div>
</div>

<div x-cloak x-data x-show="$store.notification.visible"
     class="rounded-xl fixed flex justify-center items-center shadow-lg top-4 right-2 sm:right-3 md:right-4 z-[9999] bg-violet-600"
     x-transition:enter="transform transition ease-out duration-300"
     x-transition:enter-start="translate-x-full opacity-0"
     x-transition:enter-end="translate-x-0 opacity-100"
     x-transition:leave="transform transition ease-in duration-300"
     x-transition:leave-start="translate-x-0 opacity-100"
     x-transition:leave-end="translate-x-full opacity-0">
    <div x-text="$store.notification.data"
         class="text-center px-2 py-4 sm:p-4 text-wrap"></div>
</div>

<script>
    function postForm() {
        return {
            login: '',
            password: '',
            submitting: false,
            error: '',
            submit(e) {
                this.submitting = true
                this.error = ''
                const form = e.target
                try {
                    fetch('/hybrid-registration', {
                        method: 'POST',
                        body: new FormData(form),
                        headers: {'Accept': 'application/json'}
                    }).then(res => res.json())
                        .then(res => {
                            if (!res.result) {
                                this.error = res.message || '–ù–µ –≤–¥–∞–ª–æ—Å—è... ;('
                            } else {
                                form.reset()
                                this.name = ''

                                Alpine.store('auth').success()
                            }
                        })
                } catch (err) {
                    console.error(err)
                    this.error = '–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ'
                } finally {
                    this.submitting = false;
                }
            }
        }
    }

    function sendLogout() {
        return {
            error: '',
            async logout() {
                const res = await fetch('/logout', {
                    headers: {'Accept': 'application/json'}
                })
                if (!res.ok) {
                    this.error = await res.text() || '–ù–µ –≤–¥–∞–ª–æ—Å—è... ;('
                    return;
                }
                Alpine.store('logout').success()
            }
        }
    }
</script>
</body>
</html>
